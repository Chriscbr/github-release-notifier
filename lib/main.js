"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GitClient = exports.GithubClient = exports.ActionMode = void 0;
const cp = require("child_process");
const core = require("@actions/core");
const github = require("@actions/github");
const constants_1 = require("./constants");
const util_1 = require("./util");
var ActionMode;
(function (ActionMode) {
    /**
     * Backfills previous pull requests and issues with release reminders
     * for all previous releases as a bulk operation.
     *
     * The operation will finish when the max-backfill-operations limit is
     * reached, or when all releases have been backfilled.
     */
    ActionMode["ALL"] = "all";
    /**
     * Add release reminders to issues and pull requests for only the
     * latest available release.
     */
    ActionMode["LATEST"] = "latest";
})(ActionMode = exports.ActionMode || (exports.ActionMode = {}));
function getContext() {
    core.debug(`owner: ${github.context.repo.owner}`);
    core.debug(`repo: ${github.context.repo.repo}`);
    return github.context.repo;
}
function getOptions() {
    core.debug(`mode: ${core.getInput('mode')}`);
    core.debug(`maximum-comments: ${core.getInput('maximum-comments')}`);
    const mode = ActionMode[core.getInput('mode')];
    const maximumComments = parseInt(core.getInput('maximum-comments'), 10); // may be NaN
    const options = {
        mode: mode !== null && mode !== void 0 ? mode : ActionMode.LATEST,
        maximumComments: maximumComments || 50,
    };
    core.debug(`options: ${JSON.stringify(options)}`);
    return options;
}
class GithubClient {
    constructor(octokit, owner, repo) {
        this.octokit = octokit;
        this.owner = owner;
        this.repo = repo;
    }
    async getLatestRelease() {
        var _a;
        const response = await this.octokit.request(`GET /repos/${this.owner}/${this.repo}/releases/latest`);
        core.debug(`getLatestRelease: (${response.status}) ${(_a = response.data) === null || _a === void 0 ? void 0 : _a.name}`);
        return response.data;
    }
    async getPullRequestsFromCommit(commitSha) {
        var _a;
        const response = await this.octokit.request(`GET /repos/${this.owner}/${this.repo}/commits/${commitSha}/pulls`, {
            // specify a media type because this feature is in preview
            mediaType: {
                previews: ['groot'],
            },
        });
        core.debug(`getPullRequestsFromCommit: (${response.status}) ${(_a = response.data) === null || _a === void 0 ? void 0 : _a.map((pr) => pr.url).join('\n')}`);
        return response.data;
    }
    async getIssue(issueNumber) {
        var _a;
        const response = await this.octokit.request(`GET /repos/${this.owner}/${this.repo}/issues/${issueNumber}`);
        core.debug(`getIssue: (${response.status}) #${(_a = response.data) === null || _a === void 0 ? void 0 : _a.number}`);
        return response.data;
    }
    async addComment(issueNumber, body) {
        core.debug(`adding comment to #${issueNumber}...`);
        await this.octokit.request(`POST /repos/${this.owner}/${this.repo}/issues/${issueNumber}/comments`, {
            body: body,
        });
    }
}
exports.GithubClient = GithubClient;
class GitClient {
    constructor() {
        this.workspace = this.setupWorkspace();
    }
    setupWorkspace() {
        if (!process.env.GITHUB_WORKSPACE) {
            throw new Error('GITHUB_WORKSPACE is not set in the current repository!');
        }
        return process.env.GITHUB_WORKSPACE;
    }
    getTag(tag) {
        return cp.execSync(`git show-ref -s ${tag}`, { cwd: this.workspace }).toString().trim();
    }
    getPreviousTag(tag) {
        return cp.execSync(`git describe --tags --abbrev=0 ${tag}^`, { cwd: this.workspace }).toString().trim();
    }
    /**
     * Returns a list of commit hashes beginning AFTER fromTag, up to and
     * INCLUDING toTag.
     */
    getCommitsBetweenTags(fromTag, toTag) {
        return cp.execSync(`git rev-list ${fromTag}..${toTag}`).toString().trim().split('\n');
    }
}
exports.GitClient = GitClient;
async function getPullRequests(gitClient, githubClient, release) {
    core.debug(`getting pull requests for release: ${release.name}`);
    const tag = release.tag_name;
    core.debug(`tag: ${tag}`);
    const previousTag = gitClient.getPreviousTag(tag);
    core.debug(`previousTag: ${previousTag}`);
    const commits = gitClient.getCommitsBetweenTags(previousTag, tag);
    core.debug(`commits: ${commits}`);
    const promises = commits.map((commitSha) => githubClient.getPullRequestsFromCommit(commitSha));
    const pullRequests = (await resolveAndReturnSuccesses(promises)).flat();
    // TODO: validate that the pull request was actually merged?
    // https://docs.github.com/en/rest/reference/pulls#check-if-a-pull-request-has-been-merged
    core.debug(`pullRequests: ${pullRequests.map(pr => pr.url)}`);
    return pullRequests;
}
/**
 * Returns a list of issue numbers mentioned in a pull request description.
 * @see https://docs.github.com/en/issues/tracking-your-work-with-issues/linking-a-pull-request-to-an-issue#linking-a-pull-request-to-an-issue-using-a-keyword
 */
function parseIssueNumbers(description) {
    const output = [];
    for (const re of constants_1.LINKED_ISSUE_REGEXES) {
        const matches = description.matchAll(re);
        for (const match of matches) {
            const issueNumber = match[1]; // grab the captured group
            output.push(parseInt(issueNumber));
        }
    }
    return output;
}
async function getLinkedIssues(githubClient, pullRequest) {
    core.debug(`getting linked issues for pull request: #${pullRequest.number}`);
    const prBody = pullRequest.body.toLowerCase();
    const issueNumbers = util_1.dedupArray(parseIssueNumbers(prBody));
    core.debug(`issue numbers found: [${issueNumbers.map((num) => '#' + num).join(',')}]`);
    const issues = await resolveAndReturnSuccesses(issueNumbers.map((issueNum) => githubClient.getIssue(issueNum)));
    core.debug(`issues: ${issues.map(issue => issue.url).join('\n')}`);
    return issues;
}
async function resolveAndReturnSuccesses(promises) {
    const promiseResults = await Promise.allSettled(promises);
    const output = [];
    for (const result of promiseResults) {
        if (result.status === 'fulfilled') {
            output.push(result.value);
        }
    }
    return output;
}
// TODO: filter out PRs/issues that have already been commented on
async function commentOn(githubClient, pullRequest, issues, repo, release) {
    const promises = [];
    const prMessage = constants_1.PR_COMMENT_TEMPLATE(repo, release.name);
    promises.push(githubClient.addComment(pullRequest.number, prMessage));
    for (const issue of issues) {
        const issueMessage = constants_1.ISSUE_COMMENT_TEMPLATE(pullRequest.number, repo, release.name);
        promises.push(githubClient.addComment(issue.number, issueMessage));
    }
    const results = await Promise.allSettled(promises);
    let total = 0;
    for (const result of results) {
        if (result.status === 'rejected') {
            core.error(`error commenting on issue/pr: ${result.reason}`);
            continue;
        }
        total += 1;
    }
    return total;
}
async function run() {
    try {
        const options = getOptions();
        const { owner, repo } = getContext();
        if (options.mode !== ActionMode.LATEST) {
            throw new Error('Only "latest" mode is currently supported.');
        }
        const token = core.getInput('token', { required: true });
        if (token === 'DEBUG_TOKEN') {
            core.info('DEBUG_TOKEN has been provided, exiting early.');
            core.setOutput('total-comments', 0);
            return;
        }
        const octokit = github.getOctokit(token);
        const githubClient = new GithubClient(octokit, owner, repo);
        const gitClient = new GitClient();
        const latestRelease = await githubClient.getLatestRelease();
        const pullRequests = await getPullRequests(gitClient, githubClient, latestRelease);
        let totalComments = 0;
        for (const pullRequest of pullRequests) {
            const issues = await getLinkedIssues(githubClient, pullRequest);
            totalComments += await commentOn(githubClient, pullRequest, issues, repo, latestRelease);
        }
        core.setOutput('total-comments', totalComments);
    }
    catch (error) {
        core.setFailed(error.message);
    }
}
// eslint-disable-next-line @typescript-eslint/no-floating-promises
run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9DQUFvQztBQUNwQyxzQ0FBc0M7QUFDdEMsMENBQTBDO0FBQzFDLDJDQUFnRztBQUVoRyxpQ0FBb0M7QUFFcEMsSUFBWSxVQWVYO0FBZkQsV0FBWSxVQUFVO0lBQ3BCOzs7Ozs7T0FNRztJQUNILHlCQUFXLENBQUE7SUFFWDs7O09BR0c7SUFDSCwrQkFBaUIsQ0FBQTtBQUNuQixDQUFDLEVBZlcsVUFBVSxHQUFWLGtCQUFVLEtBQVYsa0JBQVUsUUFlckI7QUFnQkQsU0FBUyxVQUFVO0lBQ2pCLElBQUksQ0FBQyxLQUFLLENBQUMsVUFBVSxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ2xELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ2hELE9BQU8sTUFBTSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7QUFDN0IsQ0FBQztBQUVELFNBQVMsVUFBVTtJQUNqQixJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDN0MsSUFBSSxDQUFDLEtBQUssQ0FBQyxxQkFBcUIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUVyRSxNQUFNLElBQUksR0FBaUMsVUFBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUM5RSxNQUFNLGVBQWUsR0FBVyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUM5RixNQUFNLE9BQU8sR0FBRztRQUNkLElB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Q0FBQztLQUNqRDtJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDL0I7QUFDSCxDQUFDO0FBRUQsbUVBQW1FO0FBQ25FLEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0BhY3Rpb25zL2NvcmUnO1xuaW1wb3J0ICogYXMgZ2l0aHViIGZyb20gJ0BhY3Rpb25zL2dpdGh1Yic7XG5pbXBvcnQgeyBJU1NVRV9DT01NRU5UX1RFTVBMQVRFLCBMSU5LRURfSVNTVUVfUkVHRVhFUywgUFJfQ09NTUVOVF9URU1QTEFURSB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IEdpdGh1Yklzc3VlLCBHaXRodWJQdWxsUmVxdWVzdCwgR2l0aHViUmVsZWFzZSB9IGZyb20gJy4vdHlwZXMnO1xuaW1wb3J0IHsgZGVkdXBBcnJheSB9IGZyb20gJy4vdXRpbCc7XG5cbmV4cG9ydCBlbnVtIEFjdGlvbk1vZGUge1xuICAvKipcbiAgICogQmFja2ZpbGxzIHByZXZpb3VzIHB1bGwgcmVxdWVzdHMgYW5kIGlzc3VlcyB3aXRoIHJlbGVhc2UgcmVtaW5kZXJzXG4gICAqIGZvciBhbGwgcHJldmlvdXMgcmVsZWFzZXMgYXMgYSBidWxrIG9wZXJhdGlvbi5cbiAgICpcbiAgICogVGhlIG9wZXJhdGlvbiB3aWxsIGZpbmlzaCB3aGVuIHRoZSBtYXgtYmFja2ZpbGwtb3BlcmF0aW9ucyBsaW1pdCBpc1xuICAgKiByZWFjaGVkLCBvciB3aGVuIGFsbCByZWxlYXNlcyBoYXZlIGJlZW4gYmFja2ZpbGxlZC5cbiAgICovXG4gIEFMTCA9ICdhbGwnLFxuXG4gIC8qKlxuICAgKiBBZGQgcmVsZWFzZSByZW1pbmRlcnMgdG8gaXNzdWVzIGFuZCBwdWxsIHJlcXVlc3RzIGZvciBvbmx5IHRoZVxuICAgKiBsYXRlc3QgYXZhaWxhYmxlIHJlbGVhc2UuXG4gICAqL1xuICBMQVRFU1QgPSAnbGF0ZXN0J1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGlvbk9wdGlvbnMge1xuICAvKipcbiAgICogTW9kZSBvZiBydW5uaW5nIHRoZSBhY3Rpb24uXG4gICAqIEBkZWZhdWx0IEFjdGlvbk1vZGUuTEFURVNUXG4gICAqL1xuICByZWFkb25seSBtb2RlPzogQWN0aW9uTW9kZTtcblxuICAvKipcbiAgICogTWF4aW11bSBudW1iZXIgb2YgY29tbWVudHMgdG8gYXBwbHkgd2hpbGUgcnVubmluZyB0aGUgYWN0aW9uLlxuICAgKiBAZGVmYXVsdCA1MFxuICAgKi9cbiAgcmVhZG9ubHkgbWF4aW11bUNvbW1lbnRzPzogbnVtYmVyO1xufVxuXG5mdW5jdGlvbiBnZXRDb250ZXh0KCkge1xuICBjb3JlLmRlYnVnKGBvd25lcjogJHtnaXRodWIuY29udGV4dC5yZXBvLm93bmVyfWApO1xuICBjb3JlLmRlYnVnKGByZXBvOiAke2dpdGh1Yi5jb250ZXh0LnJlcG8ucmVwb31gKTtcbiAgcmV0dXJuIGdpdGh1Yi5jb250ZXh0LnJlcG87XG59XG5cbmZ1bmN0aW9uIGdldE9wdGlvbnMoKTogQWN0aW9uT3B0aW9ucyB7XG4gIGNvcmUuZGVidWcoYG1vZGU6ICR7Y29yZS5nZXRJbnB1dCgnbW9kZScpfWApO1xuICBjb3JlLmRlYnVnKGBtYXhpbXVtLWNvbW1lbnRzOiAke2NvcmUuZ2V0SW5wdXQoJ21heGltdW0tY29tbWVudHMnKX1gKTtcblxuICBjb25zdCBtb2RlOiBBY3Rpb25Nb2RlIHwgdW5kZWZpbmVkID0gKDxhbnk+QWN0aW9uTW9kZSlbY29yZS5nZXRJbnB1dCgnbW9kZScpXTtcbiAgY29uc3QgbWF4aW11bUNvbW1lbnRzOiBudW1iZXIgPSBwYXJzZUludChjb3JlLmdldElucHV0KCdtYXhpbXVtLWNvbW1lbnRzJyksIDEwKTsgLy8gbWF5IGJlIE5hTlxuICBjb25zdCBvcHRpb25zID0ge1xuICAgIG1vZGU6IG1vZGUgPz8gQWN0aW9uTW9kZS5MQVRFU1QsXG4gICAgbWF4aW11bUNvbW1lbnRzOiBtYXhpbXVtQ29tbWVudHMgfHwgNTAsXG4gIH07XG5cbiAgY29yZS5kZWJ1Zyhgb3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShvcHRpb25zKX1gKTtcblxuICByZXR1cm4gb3B0aW9ucztcbn1cblxudHlwZSBIeWRyYXRlZE9jdG9raXQgPSBSZXR1cm5UeXBlPHR5cGVvZiBnaXRodWIuZ2V0T2N0b2tpdD5cblxuZXhwb3J0IGNsYXNzIEdpdGh1YkNsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgb2N0b2tpdDogSHlkcmF0ZWRPY3Rva2l0O1xuICBwcml2YXRlIHJlYWRvbmx5IG93bmVyOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVwbzogc3RyaW5nO1xuICBjb25zdHJ1Y3RvcihvY3Rva2l0OiBIeWRyYXRlZE9jdG9raXQsIG93bmVyOiBzdHJpbmcsIHJlcG86IHN0cmluZykge1xuICAgIHRoaXMub2N0b2tpdCA9IG9jdG9raXQ7XG4gICAgdGhpcy5vd25lciA9IG93bmVyO1xuICAgIHRoaXMucmVwbyA9IHJlcG87XG4gIH1cblxuICBhc3luYyBnZXRMYXRlc3RSZWxlYXNlKCk6IFByb21pc2U8R2l0aHViUmVsZWFzZT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vY3Rva2l0LnJlcXVlc3QoYEdFVCAvcmVwb3MvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vcmVsZWFzZXMvbGF0ZXN0YCk7XG4gICAgY29yZS5kZWJ1ZyhgZ2V0TGF0ZXN0UmVsZWFzZTogKCR7cmVzcG9uc2Uuc3RhdHVzfSkgJHtyZXNwb25zZS5kYXRhPy5uYW1lfWApO1xuXG4gICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gIH1cblxuICBhc3luYyBnZXRQdWxsUmVxdWVzdHNGcm9tQ29tbWl0KGNvbW1pdFNoYTogc3RyaW5nKTogUHJvbWlzZTxHaXRodWJQdWxsUmVxdWVzdFtdPiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLm9jdG9raXQucmVxdWVzdChgR0VUIC9yZXBvcy8ke3RoaXMub3duZXJ9LyR7dGhpcy5yZXBvfS9jb21taXRzLyR7Y29tbWl0U2hhfS9wdWxsc2AsIHtcbiAgICAgIC8vIHNwZWNpZnkgYSBtZWRpYSB0eXBlIGJlY2F1c2UgdGhpcyBmZWF0dXJlIGlzIGluIHByZXZpZXdcbiAgICAgIG1lZGlhVHlwZToge1xuICAgICAgICBwcmV2aWV3czogWydncm9vdCddLFxuICAgICAgfSxcbiAgICB9KTtcbiAgICBjb3JlLmRlYnVnKGBnZXRQdWxsUmVxdWVzdHNGcm9tQ29tbWl0OiAoJHtyZXNwb25zZS5zdGF0dXN9KSAke3Jlc3BvbnNlLmRhdGE/Lm1hcCgocHI6IEdpdGh1YlB1bGxSZXF1ZXN0KSA9PiBwci51cmwpLmpvaW4oJ1xcbicpfWApO1xuXG4gICAgcmV0dXJuIHJlc3BvbnNlLmRhdGE7XG4gIH1cblxuICBhc3luYyBnZXRJc3N1ZShpc3N1ZU51bWJlcjogbnVtYmVyKTogUHJvbWlzZTxHaXRodWJJc3N1ZT4ge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5vY3Rva2l0LnJlcXVlc3QoYEdFVCAvcmVwb3MvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyR7aXNzdWVOdW1iZXJ9YCk7XG4gICAgY29yZS5kZWJ1ZyhgZ2V0SXNzdWU6ICgke3Jlc3BvbnNlLnN0YXR1c30pICMke3Jlc3BvbnNlLmRhdGE/Lm51bWJlcn1gKTtcblxuICAgIHJldHVybiByZXNwb25zZS5kYXRhO1xuICB9XG5cbiAgYXN5bmMgYWRkQ29tbWVudChpc3N1ZU51bWJlcjogbnVtYmVyLCBib2R5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb3JlLmRlYnVnKGBhZGRpbmcgY29tbWVudCB0byAjJHtpc3N1ZU51bWJlcn0uLi5gKTtcbiAgICBhd2FpdCB0aGlzLm9jdG9raXQucmVxdWVzdChgUE9TVCAvcmVwb3MvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vaXNzdWVzLyR7aXNzdWVOdW1iZXJ9L2NvbW1lbnRzYCwge1xuICAgICAgYm9keTogYm9keSxcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgR2l0Q2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSB3b3Jrc3BhY2U6IHN0cmluZztcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy53b3Jrc3BhY2UgPSB0aGlzLnNldHVwV29ya3NwYWNlKCk7XG4gIH1cblxuICBzZXR1cFdvcmtzcGFjZSgpIHtcbiAgICBpZiAoIXByb2Nlc3MuZW52LkdJVEhVQl9XT1JLU1BBQ0UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignR0lUSFVCX1dPUktTUEFDRSBpcyBub3Qgc2V0IGluIHRoZSBjdXJyZW50IHJlcG9zaXRvcnkhJyk7XG4gICAgfVxuICAgIHJldHVybiBwcm9jZXNzLmVudi5HSVRIVUJfV09SS1NQQUNFO1xuICB9XG5cbiAgZ2V0VGFnKHRhZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY3AuZXhlY1N5bmMoYGdpdCBzaG93LXJlZiAtcyAke3RhZ31gLCB7IGN3ZDogdGhpcy53b3Jrc3BhY2UgfSkudG9TdHJpbmcoKS50cmltKCk7XG4gIH1cblxuICBnZXRQcmV2aW91c1RhZyh0YWc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNwLmV4ZWNTeW5jKGBnaXQgZGVzY3JpYmUgLS10YWdzIC0tYWJicmV2PTAgJHt0YWd9XmAsIHsgY3dkOiB0aGlzLndvcmtzcGFjZSB9KS50b1N0cmluZygpLnRyaW0oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgbGlzdCBvZiBjb21taXQgaGFzaGVzIGJlZ2lubmluZyBBRlRFUiBmcm9tVGFnLCB1cCB0byBhbmRcbiAgICogSU5DTFVESU5HIHRvVGFnLlxuICAgKi9cbiAgZ2V0Q29tbWl0c0JldHdlZW5UYWdzKGZyb21UYWc6IHN0cmluZywgdG9UYWc6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gY3AuZXhlY1N5bmMoYGdpdCByZXYtbGlzdCAke2Zyb21UYWd9Li4ke3RvVGFnfWApLnRvU3RyaW5nKCkudHJpbSgpLnNwbGl0KCdcXG4nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRQdWxsUmVxdWVzdHMoZ2l0Q2xpZW50OiBHaXRDbGllbnQsIGdpdGh1YkNsaWVudDogR2l0aHViQ2xpZW50LCByZWxlYXNlOiBHaXRodWJSZWxlYXNlKTogUHJvbWlzZTxHaXRodWJQdWxsUmVxdWVzdFtdPiB7XG4gIGNvcmUuZGVidWcoYGdldHRpbmcgcHVsbCByZXF1ZXN0cyBmb3IgcmVsZWFzZTogJHtyZWxlYXNlLm5hbWV9YCk7XG5cbiAgY29uc3QgdGFnID0gcmVsZWFzZS50YWdfbmFtZTtcbiAgY29yZS5kZWJ1ZyhgdGFnOiAke3RhZ31gKTtcblxuICBjb25zdCBwcmV2aW91c1RhZyA9IGdpdENsaWVudC5nZXRQcmV2aW91c1RhZyh0YWcpO1xuICBjb3JlLmRlYnVnKGBwcmV2aW91c1RhZzogJHtwcmV2aW91c1RhZ31gKTtcblxuICBjb25zdCBjb21taXRzID0gZ2l0Q2xpZW50LmdldENvbW1pdHNCZXR3ZWVuVGFncyhwcmV2aW91c1RhZywgdGFnKTtcbiAgY29yZS5kZWJ1ZyhgY29tbWl0czogJHtjb21taXRzfWApO1xuXG4gIGNvbnN0IHByb21pc2VzID0gY29tbWl0cy5tYXAoKGNvbW1pdFNoYSkgPT4gZ2l0aHViQ2xpZW50LmdldFB1bGxSZXF1ZXN0c0Zyb21Db21taXQoY29tbWl0U2hhKSk7XG4gIGNvbnN0IHB1bGxSZXF1ZXN0czogR2l0aHViUHVsbFJlcXVlc3RbXSA9IChhd2FpdCByZXNvbHZlQW5kUmV0dXJuU3VjY2Vzc2VzKHByb21pc2VzKSkuZmxhdCgpO1xuXG4gIC8vIFRPRE86IHZhbGlkYXRlIHRoYXQgdGhlIHB1bGwgcmVxdWVzdCB3YXMgYWN0dWFsbHkgbWVyZ2VkP1xuICAvLyBodHRwczovL2RvY3MuZ2l0aHViLmNvbS9lbi9yZXN0L3JlZmVyZW5jZS9wdWxscyNjaGVjay1pZi1hLXB1bGwtcmVxdWVzdC1oYXMtYmVlbi1tZXJnZWRcblxuICBjb3JlLmRlYnVnKGBwdWxsUmVxdWVzdHM6ICR7cHVsbFJlcXVlc3RzLm1hcChwciA9PiBwci51cmwpfWApO1xuXG4gIHJldHVybiBwdWxsUmVxdWVzdHM7XG59XG5cbi8qKlxuICogUmV0dXJucyBhIGxpc3Qgb2YgaXNzdWUgbnVtYmVycyBtZW50aW9uZWQgaW4gYSBwdWxsIHJlcXVlc3QgZGVzY3JpcHRpb24uXG4gKiBAc2VlIGh0dHBzOi8vZG9jcy5naXRodWIuY29tL2VuL2lzc3Vlcy90cmFja2luZy15b3VyLXdvcmstd2l0aC1pc3N1ZXMvbGlua2luZy1hLXB1bGwtcmVxdWVzdC10by1hbi1pc3N1ZSNsaW5raW5nLWEtcHVsbC1yZXF1ZXN0LXRvLWFuLWlzc3VlLXVzaW5nLWEta2V5d29yZFxuICovXG5mdW5jdGlvbiBwYXJzZUlzc3VlTnVtYmVycyhkZXNjcmlwdGlvbjogc3RyaW5nKTogbnVtYmVyW10ge1xuICBjb25zdCBvdXRwdXQgPSBbXTtcbiAgZm9yIChjb25zdCByZSBvZiBMSU5LRURfSVNTVUVfUkVHRVhFUykge1xuICAgIGNvbnN0IG1hdGNoZXMgPSBkZXNjcmlwdGlvbi5tYXRjaEFsbChyZSk7XG4gICAgZm9yIChjb25zdCBtYXRjaCBvZiBtYXRjaGVzKSB7XG4gICAgICBjb25zdCBpc3N1ZU51bWJlciA9IG1hdGNoWzFdOyAvLyBncmFiIHRoZSBjYXB0dXJlZCBncm91cFxuICAgICAgb3V0cHV0LnB1c2gocGFyc2VJbnQoaXNzdWVOdW1iZXIpKTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG91dHB1dDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2V0TGlua2VkSXNzdWVzKGdpdGh1YkNsaWVudDogR2l0aHViQ2xpZW50LCBwdWxsUmVxdWVzdDogR2l0aHViUHVsbFJlcXVlc3QpOiBQcm9taXNlPEdpdGh1Yklzc3VlW10+IHtcbiAgY29yZS5kZWJ1ZyhgZ2V0dGluZyBsaW5rZWQgaXNzdWVzIGZvciBwdWxsIHJlcXVlc3Q6ICMke3B1bGxSZXF1ZXN0Lm51bWJlcn1gKTtcblxuICBjb25zdCBwckJvZHkgPSBwdWxsUmVxdWVzdC5ib2R5LnRvTG93ZXJDYXNlKCk7XG4gIGNvbnN0IGlzc3VlTnVtYmVyczogbnVtYmVyW10gPSBkZWR1cEFycmF5KHBhcnNlSXNzdWVOdW1iZXJzKHByQm9keSkpO1xuICBjb3JlLmRlYnVnKGBpc3N1ZSBudW1iZXJzIGZvdW5kOiBbJHtpc3N1ZU51bWJlcnMubWFwKChudW0pID0+ICcjJyArIG51bSkuam9pbignLCcpfV1gKTtcblxuICBjb25zdCBpc3N1ZXM6IEdpdGh1Yklzc3VlW10gPSBhd2FpdCByZXNvbHZlQW5kUmV0dXJuU3VjY2Vzc2VzKGlzc3VlTnVtYmVycy5tYXAoKGlzc3VlTnVtKSA9PiBnaXRodWJDbGllbnQuZ2V0SXNzdWUoaXNzdWVOdW0pKSk7XG4gIGNvcmUuZGVidWcoYGlzc3VlczogJHtpc3N1ZXMubWFwKGlzc3VlID0+IGlzc3VlLnVybCkuam9pbignXFxuJyl9YCk7XG5cbiAgcmV0dXJuIGlzc3Vlcztcbn1cblxuYXN5bmMgZnVuY3Rpb24gcmVzb2x2ZUFuZFJldHVyblN1Y2Nlc3NlczxUPihwcm9taXNlczogUHJvbWlzZTxUPltdKTogUHJvbWlzZTxUW10+IHtcbiAgY29uc3QgcHJvbWlzZVJlc3VsdHMgPSBhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpO1xuICBjb25zdCBvdXRwdXQgPSBbXTtcbiAgZm9yIChjb25zdCByZXN1bHQgb2YgcHJvbWlzZVJlc3VsdHMpIHtcbiAgICBpZiAocmVzdWx0LnN0YXR1cyA9PT0gJ2Z1bGZpbGxlZCcpIHtcbiAgICAgIG91dHB1dC5wdXNoKHJlc3VsdC52YWx1ZSk7XG4gICAgfVxuICB9XG4gIHJldHVybiBvdXRwdXQ7XG59XG5cbi8vIFRPRE86IGZpbHRlciBvdXQgUFJzL2lzc3VlcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIGNvbW1lbnRlZCBvblxuYXN5bmMgZnVuY3Rpb24gY29tbWVudE9uKFxuICBnaXRodWJDbGllbnQ6IEdpdGh1YkNsaWVudCxcbiAgcHVsbFJlcXVlc3Q6IEdpdGh1YlB1bGxSZXF1ZXN0LFxuICBpc3N1ZXM6IEdpdGh1Yklzc3VlW10sXG4gIHJlcG86IHN0cmluZyxcbiAgcmVsZWFzZTogR2l0aHViUmVsZWFzZSxcbik6IFByb21pc2U8bnVtYmVyPiB7XG4gIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgY29uc3QgcHJNZXNzYWdlID0gUFJfQ09NTUVOVF9URU1QTEFURShyZXBvLCByZWxlYXNlLm5hbWUpO1xuICBwcm9taXNlcy5wdXNoKGdpdGh1YkNsaWVudC5hZGRDb21tZW50KHB1bGxSZXF1ZXN0Lm51bWJlciwgcHJNZXNzYWdlKSk7XG5cbiAgZm9yIChjb25zdCBpc3N1ZSBvZiBpc3N1ZXMpIHtcbiAgICBjb25zdCBpc3N1ZU1lc3NhZ2UgPSBJU1NVRV9DT01NRU5UX1RFTVBMQVRFKHB1bGxSZXF1ZXN0Lm51bWJlciwgcmVwbywgcmVsZWFzZS5uYW1lKTtcbiAgICBwcm9taXNlcy5wdXNoKGdpdGh1YkNsaWVudC5hZGRDb21tZW50KGlzc3VlLm51bWJlciwgaXNzdWVNZXNzYWdlKSk7XG4gIH1cblxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgUHJvbWlzZS5hbGxTZXR0bGVkKHByb21pc2VzKTtcbiAgbGV0IHRvdGFsID0gMDtcbiAgZm9yIChjb25zdCByZXN1bHQgb2YgcmVzdWx0cykge1xuICAgIGlmIChyZXN1bHQuc3RhdHVzID09PSAncmVqZWN0ZWQnKSB7XG4gICAgICBjb3JlLmVycm9yKGBlcnJvciBjb21tZW50aW5nIG9uIGlzc3VlL3ByOiAke3Jlc3VsdC5yZWFzb259YCk7XG4gICAgICBjb250aW51ZTtcbiAgICB9XG4gICAgdG90YWwgKz0gMTtcbiAgfVxuICByZXR1cm4gdG90YWw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJ1bigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCBvcHRpb25zID0gZ2V0T3B0aW9ucygpO1xuICAgIGNvbnN0IHsgb3duZXIsIHJlcG8gfSA9IGdldENvbnRleHQoKTtcblxuICAgIGlmIChvcHRpb25zLm1vZGUgIT09IEFjdGlvbk1vZGUuTEFURVNUKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgXCJsYXRlc3RcIiBtb2RlIGlzIGN1cnJlbnRseSBzdXBwb3J0ZWQuJyk7XG4gICAgfVxuXG4gICAgY29uc3QgdG9rZW4gPSBjb3JlLmdldElucHV0KCd0b2tlbicsIHsgcmVxdWlyZWQ6IHRydWUgfSk7XG5cbiAgICBpZiAodG9rZW4gPT09ICdERUJVR19UT0tFTicpIHtcbiAgICAgIGNvcmUuaW5mbygnREVCVUdfVE9LRU4gaGFzIGJlZW4gcHJvdmlkZWQsIGV4aXRpbmcgZWFybHkuJyk7XG4gICAgICBjb3JlLnNldE91dHB1dCgndG90YWwtY29tbWVudHMnLCAwKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBvY3Rva2l0ID0gZ2l0aHViLmdldE9jdG9raXQodG9rZW4pO1xuICAgIGNvbnN0IGdpdGh1YkNsaWVudCA9IG5ldyBHaXRodWJDbGllbnQob2N0b2tpdCwgb3duZXIsIHJlcG8pO1xuICAgIGNvbnN0IGdpdENsaWVudCA9IG5ldyBHaXRDbGllbnQoKTtcblxuICAgIGNvbnN0IGxhdGVzdFJlbGVhc2UgPSBhd2FpdCBnaXRodWJDbGllbnQuZ2V0TGF0ZXN0UmVsZWFzZSgpO1xuICAgIGNvbnN0IHB1bGxSZXF1ZXN0cyA9IGF3YWl0IGdldFB1bGxSZXF1ZXN0cyhnaXRDbGllbnQsIGdpdGh1YkNsaWVudCwgbGF0ZXN0UmVsZWFzZSk7XG5cbiAgICBsZXQgdG90YWxDb21tZW50cyA9IDA7XG4gICAgZm9yIChjb25zdCBwdWxsUmVxdWVzdCBvZiBwdWxsUmVxdWVzdHMpIHtcbiAgICAgIGNvbnN0IGlzc3VlcyA9IGF3YWl0IGdldExpbmtlZElzc3VlcyhnaXRodWJDbGllbnQsIHB1bGxSZXF1ZXN0KTtcbiAgICAgIHRvdGFsQ29tbWVudHMgKz0gYXdhaXQgY29tbWVudE9uKGdpdGh1YkNsaWVudCwgcHVsbFJlcXVlc3QsIGlzc3VlcywgcmVwbywgbGF0ZXN0UmVsZWFzZSk7XG4gICAgfVxuXG4gICAgY29yZS5zZXRPdXRwdXQoJ3RvdGFsLWNvbW1lbnRzJywgdG90YWxDb21tZW50cyk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29yZS5zZXRGYWlsZWQoZXJyb3IubWVzc2FnZSk7XG4gIH1cbn1cblxuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1mbG9hdGluZy1wcm9taXNlc1xucnVuKCk7Il19
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GitClient = exports.GithubClient = exports.ActionMode = void 0;
const cp = require("child_process");
const core = require("@actions/core");
const github = require("@actions/github");
var ActionMode;
(function (ActionMode) {
    /**
     * Backfills previous pull requests and issues with release reminders
     * for all previous releases as a bulk operation.
     *
     * The operation will finish when the max-backfill-operations limit is
     * reached, or when all releases have been backfilled.
     */
    ActionMode["ALL"] = "all";
    /**
     * Add release reminders to issues and pull requests for only the
     * latest available release.
     */
    ActionMode["LATEST"] = "continuous";
})(ActionMode = exports.ActionMode || (exports.ActionMode = {}));
function getOptions() {
    const mode = ActionMode[core.getInput('mode')];
    const maximumComments = parseInt(core.getInput('maximum-comments'), 10); // may be NaN
    return {
        mode: mode !== null && mode !== void 0 ? mode : ActionMode.LATEST,
        maximumComments: maximumComments || 50,
    };
}
class GithubClient {
    constructor(octokit, owner, repo) {
        this.octokit = octokit;
        this.owner = owner;
        this.repo = repo;
    }
    async getLatestRelease() {
        return this.octokit.request(`GET /repos/${this.owner}/${this.repo}/releases/latest`);
        // return this.octokit.rest.repos.getLatestRelease({
        //   owner: this.owner,
        //   repo: this.repo,
        // });
    }
    async getPullRequests(commitSha) {
        return this.octokit.request(`GET /repos/${this.owner}/${this.repo}/commits/${commitSha}/pulls`);
    }
}
exports.GithubClient = GithubClient;
class GitClient {
    constructor() {
        this.workspace = this.setupWorkspace();
    }
    setupWorkspace() {
        if (!process.env.GITHUB_WORKSPACE) {
            throw new Error('GITHUB_WORKSPACE is not set in the current repository!');
        }
        return process.env.GITHUB_WORKSPACE;
    }
    getTag(tag) {
        return cp.execSync(`git show-ref -s ${tag}`, { cwd: this.workspace }).toString().trim();
    }
    getPreviousTag(tag) {
        return cp.execSync(`git describe --tags --abbrev=0 ${tag}^`, { cwd: this.workspace }).toString().trim();
    }
    /**
     * Returns a list of commit hashes beginning AFTER fromTag, up to and
     * INCLUDING toTag.
     */
    getCommitsBetweenTags(fromTag, toTag) {
        return cp.execSync(`git rev-list ${fromTag}..${toTag}`).toString().trim().split('\n');
    }
}
exports.GitClient = GitClient;
async function getPullRequests(gitClient, githubClient, release) {
    const tag = release.tag_name;
    const previousTag = gitClient.getPreviousTag(tag);
    const commits = gitClient.getCommitsBetweenTags(previousTag, tag);
    console.error(commits);
    const promises = commits.map((commitSha) => githubClient.getPullRequests(commitSha));
    const pullRequestsResults = (await Promise.allSettled(promises)).flat();
    const pullRequests = [];
    for (const result of pullRequestsResults) {
        if (result.status === 'fulfilled') {
            pullRequests.push(result.value.data);
        }
    }
    console.error(pullRequests);
    return pullRequests;
}
function getLinkedIssues(_pullRequests) {
    return [];
}
async function run() {
    try {
        const token = core.getInput('token', { required: true });
        const { owner, repo } = github.context.repo;
        core.debug(`owner: ${owner}`);
        core.debug(`repo: ${repo}`);
        core.debug(core.getInput('mode'));
        core.debug(core.getInput('maximum-comments'));
        core.debug(`workspace: ${process.env.GITHUB_WORKSPACE}`);
        const options = getOptions();
        core.debug(`options: ${JSON.stringify(options)}`);
        if (options.mode !== ActionMode.LATEST) {
            throw new Error('Only "latest" mode is currently supported.');
        }
        const octokit = github.getOctokit(token);
        const githubClient = new GithubClient(octokit, owner, repo);
        const gitClient = new GitClient();
        const { data: latestRelease } = await githubClient.getLatestRelease();
        core.debug(`latest release: ${JSON.stringify(latestRelease)}`);
        const pullRequests = await getPullRequests(gitClient, githubClient, latestRelease);
        core.debug('pull requests:' + pullRequests.map((pr) => pr.title).join('\n'));
        getLinkedIssues(pullRequests); // TODO
        // const totalComments = await commentOn(pullRequests, issues, release);
        core.info('Success!');
        core.setOutput('total-comments', 0); // TODO
    }
    catch (error) {
        core.setFailed(error.message);
    }
}
// eslint-disable-next-line @typescript-eslint/no-floating-promises
run();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9tYWluLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLG9DQUFvQztBQUNwQyxzQ0FBc0M7QUFDdEMsMENBQTBDO0FBSTFDLElBQVksVUFlWDtBQWZELFdBQVksVUFBVTtJQUNwQjs7Ozs7O09BTUc7SUFDSCx5QkFBVyxDQUFBO0lBRVg7OztPQUdHO0lBQ0gsbUNBQXFCLENBQUE7QUFDdkIsQ0FBQyxFQWZXLFVBQVUsR0FBVixrQkFBVSxLQUFWLGtCQUFVLFFBZXJCO0FBZ0JELFNBQVMsVUFBVTtJQUNqQixNQUFNLElBQUksR0FBaUMsVUFBVyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUM5RSxNQUFNLGVBQWUsR0FBVyxRQUFRLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxrQkFBa0IsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYTtJQUM5RixPQUFPO1FBQ0wsSUFBSSxFQUFFLElBQUksYUFBSixJQUFJLGNBQUosSUFBSSxHQUFJLFVBQVUsQ0FBQyxNQUFNO1FBQy9CLGVBQWUsRUFBRSxlQUFlLElBQUksRUFBRTtLQUN2QyxDQUFDO0FBQ0osQ0FBQztBQUlELE1BQWEsWUFBWTtJQUl2QixZQUFZLE9BQXdCLEVBQUUsS0FBYSxFQUFFLElBQVk7UUFDL0QsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbkIsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQztJQUVELEtBQUssQ0FBQyxnQkFBZ0I7UUFDcEIsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxjQUFjLElBQUksQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLElBQUksa0JBQWtCLENBQUMsQ0FBQztRQUNyRixvREFBb0Q7UUFDcEQsdUJBQXVC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LElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELE1BQU0sWUFBWSxHQUFHLE1BQU0sZUFBZSxDQUFDLFNBQVMsRUFBRSxZQUFZLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFDbkYsSUFBSSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxZQUFZLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFFN0UsZUFBZSxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUMsT0FBTztRQUV0Qyx3RUFBd0U7UUFFeEUsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUN0QixJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTztLQUM3QztJQUFDLE9BQU8sS0FBSyxFQUFFO1FBQ2QsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDL0I7QUFDSCxDQUFDO0FBRUQsbUVBQW1FO0FBQ25FLEdBQUcsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgY3AgZnJvbSAnY2hpbGRfcHJvY2Vzcyc7XG5pbXBvcnQgKiBhcyBjb3JlIGZyb20gJ0BhY3Rpb25zL2NvcmUnO1xuaW1wb3J0ICogYXMgZ2l0aHViIGZyb20gJ0BhY3Rpb25zL2dpdGh1Yic7XG5pbXBvcnQgeyBPY3Rva2l0UmVzcG9uc2UgfSBmcm9tICdAb2N0b2tpdC90eXBlcyc7XG5pbXBvcnQgeyBHaXRodWJQdWxsUmVxdWVzdCwgR2l0aHViUmVsZWFzZSB9IGZyb20gJy4vdHlwZXMnO1xuXG5leHBvcnQgZW51bSBBY3Rpb25Nb2RlIHtcbiAgLyoqXG4gICAqIEJhY2tmaWxscyBwcmV2aW91cyBwdWxsIHJlcXVlc3RzIGFuZCBpc3N1ZXMgd2l0aCByZWxlYXNlIHJlbWluZGVyc1xuICAgKiBmb3IgYWxsIHByZXZpb3VzIHJlbGVhc2VzIGFzIGEgYnVsayBvcGVyYXRpb24uXG4gICAqXG4gICAqIFRoZSBvcGVyYXRpb24gd2lsbCBmaW5pc2ggd2hlbiB0aGUgbWF4LWJhY2tmaWxsLW9wZXJhdGlvbnMgbGltaXQgaXNcbiAgICogcmVhY2hlZCwgb3Igd2hlbiBhbGwgcmVsZWFzZXMgaGF2ZSBiZWVuIGJhY2tmaWxsZWQuXG4gICAqL1xuICBBTEwgPSAnYWxsJyxcblxuICAvKipcbiAgICogQWRkIHJlbGVhc2UgcmVtaW5kZXJzIHRvIGlzc3VlcyBhbmQgcHVsbCByZXF1ZXN0cyBmb3Igb25seSB0aGVcbiAgICogbGF0ZXN0IGF2YWlsYWJsZSByZWxlYXNlLlxuICAgKi9cbiAgTEFURVNUID0gJ2NvbnRpbnVvdXMnXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWN0aW9uT3B0aW9ucyB7XG4gIC8qKlxuICAgKiBNb2RlIG9mIHJ1bm5pbmcgdGhlIGFjdGlvbi5cbiAgICogQGRlZmF1bHQgQWN0aW9uTW9kZS5MQVRFU1RcbiAgICovXG4gIHJlYWRvbmx5IG1vZGU/OiBBY3Rpb25Nb2RlO1xuXG4gIC8qKlxuICAgKiBNYXhpbXVtIG51bWJlciBvZiBjb21tZW50cyB0byBhcHBseSB3aGlsZSBydW5uaW5nIHRoZSBhY3Rpb24uXG4gICAqIEBkZWZhdWx0IDUwXG4gICAqL1xuICByZWFkb25seSBtYXhpbXVtQ29tbWVudHM/OiBudW1iZXI7XG59XG5cbmZ1bmN0aW9uIGdldE9wdGlvbnMoKTogQWN0aW9uT3B0aW9ucyB7XG4gIGNvbnN0IG1vZGU6IEFjdGlvbk1vZGUgfCB1bmRlZmluZWQgPSAoPGFueT5BY3Rpb25Nb2RlKVtjb3JlLmdldElucHV0KCdtb2RlJyldO1xuICBjb25zdCBtYXhpbXVtQ29tbWVudHM6IG51bWJlciA9IHBhcnNlSW50KGNvcmUuZ2V0SW5wdXQoJ21heGltdW0tY29tbWVudHMnKSwgMTApOyAvLyBtYXkgYmUgTmFOXG4gIHJldHVybiB7XG4gICAgbW9kZTogbW9kZSA/PyBBY3Rpb25Nb2RlLkxBVEVTVCxcbiAgICBtYXhpbXVtQ29tbWVudHM6IG1heGltdW1Db21tZW50cyB8fCA1MCxcbiAgfTtcbn1cblxudHlwZSBIeWRyYXRlZE9jdG9raXQgPSBSZXR1cm5UeXBlPHR5cGVvZiBnaXRodWIuZ2V0T2N0b2tpdD5cblxuZXhwb3J0IGNsYXNzIEdpdGh1YkNsaWVudCB7XG4gIHByaXZhdGUgcmVhZG9ubHkgb2N0b2tpdDogSHlkcmF0ZWRPY3Rva2l0O1xuICBwcml2YXRlIHJlYWRvbmx5IG93bmVyOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgcmVwbzogc3RyaW5nO1xuICBjb25zdHJ1Y3RvcihvY3Rva2l0OiBIeWRyYXRlZE9jdG9raXQsIG93bmVyOiBzdHJpbmcsIHJlcG86IHN0cmluZykge1xuICAgIHRoaXMub2N0b2tpdCA9IG9jdG9raXQ7XG4gICAgdGhpcy5vd25lciA9IG93bmVyO1xuICAgIHRoaXMucmVwbyA9IHJlcG87XG4gIH1cblxuICBhc3luYyBnZXRMYXRlc3RSZWxlYXNlKCk6IFByb21pc2U8T2N0b2tpdFJlc3BvbnNlPEdpdGh1YlJlbGVhc2UsIG51bWJlcj4+IHtcbiAgICByZXR1cm4gdGhpcy5vY3Rva2l0LnJlcXVlc3QoYEdFVCAvcmVwb3MvJHt0aGlzLm93bmVyfS8ke3RoaXMucmVwb30vcmVsZWFzZXMvbGF0ZXN0YCk7XG4gICAgLy8gcmV0dXJuIHRoaXMub2N0b2tpdC5yZXN0LnJlcG9zLmdldExhdGVzdFJlbGVhc2Uoe1xuICAgIC8vICAgb3duZXI6IHRoaXMub3duZXIsXG4gICAgLy8gICByZXBvOiB0aGlzLnJlcG8sXG4gICAgLy8gfSk7XG4gIH1cblxuICBhc3luYyBnZXRQdWxsUmVxdWVzdHMoY29tbWl0U2hhOiBzdHJpbmcpOiBQcm9taXNlPE9jdG9raXRSZXNwb25zZTxHaXRodWJQdWxsUmVxdWVzdCwgbnVtYmVyPj4ge1xuICAgIHJldHVybiB0aGlzLm9jdG9raXQucmVxdWVzdChgR0VUIC9yZXBvcy8ke3RoaXMub3duZXJ9LyR7dGhpcy5yZXBvfS9jb21taXRzLyR7Y29tbWl0U2hhfS9wdWxsc2ApO1xuICB9XG5cbiAgLy8gZ2V0VGFnKHRhZzogc3RyaW5nKSB7XG4gIC8vICAgLy8gcmV0dXJuIHRoaXMub2N0b2tpdC5yZXF1ZXN0KGBHRVQgL3JlcG9zLyR7dGhpcy5vd25lcn0vJHt0aGlzLnJlcG99L2dpdC9yZWZzL3RhZ3MvJHt0YWd9YCk7XG4gIC8vICAgcmV0dXJuIHRoaXMub2N0b2tpdC5yZXN0LmdpdC5nZXRSZWYoe1xuICAvLyAgICAgb3duZXI6IHRoaXMub3duZXIsXG4gIC8vICAgICByZXBvOiB0aGlzLnJlcG8sXG4gIC8vICAgICByZWY6IGByZWZzL3RhZ3MvJHt0YWd9YCxcbiAgLy8gICB9KTtcbiAgLy8gfVxufVxuXG5leHBvcnQgY2xhc3MgR2l0Q2xpZW50IHtcbiAgcHJpdmF0ZSByZWFkb25seSB3b3Jrc3BhY2U6IHN0cmluZztcbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy53b3Jrc3BhY2UgPSB0aGlzLnNldHVwV29ya3NwYWNlKCk7XG4gIH1cblxuICBzZXR1cFdvcmtzcGFjZSgpIHtcbiAgICBpZiAoIXByb2Nlc3MuZW52LkdJVEhVQl9XT1JLU1BBQ0UpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignR0lUSFVCX1dPUktTUEFDRSBpcyBub3Qgc2V0IGluIHRoZSBjdXJyZW50IHJlcG9zaXRvcnkhJyk7XG4gICAgfVxuICAgIHJldHVybiBwcm9jZXNzLmVudi5HSVRIVUJfV09SS1NQQUNFO1xuICB9XG5cbiAgZ2V0VGFnKHRhZzogc3RyaW5nKTogc3RyaW5nIHtcbiAgICByZXR1cm4gY3AuZXhlY1N5bmMoYGdpdCBzaG93LXJlZiAtcyAke3RhZ31gLCB7IGN3ZDogdGhpcy53b3Jrc3BhY2UgfSkudG9TdHJpbmcoKS50cmltKCk7XG4gIH1cblxuICBnZXRQcmV2aW91c1RhZyh0YWc6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGNwLmV4ZWNTeW5jKGBnaXQgZGVzY3JpYmUgLS10YWdzIC0tYWJicmV2PTAgJHt0YWd9XmAsIHsgY3dkOiB0aGlzLndvcmtzcGFjZSB9KS50b1N0cmluZygpLnRyaW0oKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm5zIGEgbGlzdCBvZiBjb21taXQgaGFzaGVzIGJlZ2lubmluZyBBRlRFUiBmcm9tVGFnLCB1cCB0byBhbmRcbiAgICogSU5DTFVESU5HIHRvVGFnLlxuICAgKi9cbiAgZ2V0Q29tbWl0c0JldHdlZW5UYWdzKGZyb21UYWc6IHN0cmluZywgdG9UYWc6IHN0cmluZyk6IHN0cmluZ1tdIHtcbiAgICByZXR1cm4gY3AuZXhlY1N5bmMoYGdpdCByZXYtbGlzdCAke2Zyb21UYWd9Li4ke3RvVGFnfWApLnRvU3RyaW5nKCkudHJpbSgpLnNwbGl0KCdcXG4nKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBnZXRQdWxsUmVxdWVzdHMoZ2l0Q2xpZW50OiBHaXRDbGllbnQsIGdpdGh1YkNsaWVudDogR2l0aHViQ2xpZW50LCByZWxlYXNlOiBHaXRodWJSZWxlYXNlKTogUHJvbWlzZTxHaXRodWJQdWxsUmVxdWVzdFtdPiB7XG4gIGNvbnN0IHRhZyA9IHJlbGVhc2UudGFnX25hbWU7XG4gIGNvbnN0IHByZXZpb3VzVGFnID0gZ2l0Q2xpZW50LmdldFByZXZpb3VzVGFnKHRhZyk7XG4gIGNvbnN0IGNvbW1pdHMgPSBnaXRDbGllbnQuZ2V0Q29tbWl0c0JldHdlZW5UYWdzKHByZXZpb3VzVGFnLCB0YWcpO1xuICBjb25zb2xlLmVycm9yKGNvbW1pdHMpO1xuXG4gIGNvbnN0IHByb21pc2VzID0gY29tbWl0cy5tYXAoKGNvbW1pdFNoYSkgPT4gZ2l0aHViQ2xpZW50LmdldFB1bGxSZXF1ZXN0cyhjb21taXRTaGEpKTtcbiAgY29uc3QgcHVsbFJlcXVlc3RzUmVzdWx0cyA9IChhd2FpdCBQcm9taXNlLmFsbFNldHRsZWQocHJvbWlzZXMpKS5mbGF0KCk7XG4gIGNvbnN0IHB1bGxSZXF1ZXN0cyA9IFtdO1xuICBmb3IgKGNvbnN0IHJlc3VsdCBvZiBwdWxsUmVxdWVzdHNSZXN1bHRzKSB7XG4gICAgaWYgKHJlc3VsdC5zdGF0dXMgPT09ICdmdWxmaWxsZWQnKSB7XG4gICAgICBwdWxsUmVxdWVzdHMucHVzaChyZXN1bHQudmFsdWUuZGF0YSk7XG4gICAgfVxuICB9XG4gIGNvbnNvbGUuZXJyb3IocHVsbFJlcXVlc3RzKTtcbiAgcmV0dXJuIHB1bGxSZXF1ZXN0cztcbn1cblxuZnVuY3Rpb24gZ2V0TGlua2VkSXNzdWVzKF9wdWxsUmVxdWVzdHM6IEdpdGh1YlB1bGxSZXF1ZXN0W10pOiBhbnlbXSB7IC8vIFRPRE86IHR5cGUgcHJvcGVybHlcbiAgcmV0dXJuIFtdO1xufVxuXG5hc3luYyBmdW5jdGlvbiBydW4oKTogUHJvbWlzZTx2b2lkPiB7XG4gIHRyeSB7XG4gICAgY29uc3QgdG9rZW4gPSBjb3JlLmdldElucHV0KCd0b2tlbicsIHsgcmVxdWlyZWQ6IHRydWUgfSk7XG4gICAgY29uc3QgeyBvd25lciwgcmVwbyB9ID0gZ2l0aHViLmNvbnRleHQucmVwbztcbiAgICBjb3JlLmRlYnVnKGBvd25lcjogJHtvd25lcn1gKTtcbiAgICBjb3JlLmRlYnVnKGByZXBvOiAke3JlcG99YCk7XG4gICAgY29yZS5kZWJ1Zyhjb3JlLmdldElucHV0KCdtb2RlJykpO1xuICAgIGNvcmUuZGVidWcoY29yZS5nZXRJbnB1dCgnbWF4aW11bS1jb21tZW50cycpKTtcbiAgICBjb3JlLmRlYnVnKGB3b3Jrc3BhY2U6ICR7cHJvY2Vzcy5lbnYuR0lUSFVCX1dPUktTUEFDRX1gKTtcblxuICAgIGNvbnN0IG9wdGlvbnMgPSBnZXRPcHRpb25zKCk7XG4gICAgY29yZS5kZWJ1Zyhgb3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShvcHRpb25zKX1gKTtcblxuICAgIGlmIChvcHRpb25zLm1vZGUgIT09IEFjdGlvbk1vZGUuTEFURVNUKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ09ubHkgXCJsYXRlc3RcIiBtb2RlIGlzIGN1cnJlbnRseSBzdXBwb3J0ZWQuJyk7XG4gICAgfVxuXG4gICAgY29uc3Qgb2N0b2tpdCA9IGdpdGh1Yi5nZXRPY3Rva2l0KHRva2VuKTtcbiAgICBjb25zdCBnaXRodWJDbGllbnQgPSBuZXcgR2l0aHViQ2xpZW50KG9jdG9raXQsIG93bmVyLCByZXBvKTtcbiAgICBjb25zdCBnaXRDbGllbnQgPSBuZXcgR2l0Q2xpZW50KCk7XG5cbiAgICBjb25zdCB7IGRhdGE6IGxhdGVzdFJlbGVhc2UgfSA9IGF3YWl0IGdpdGh1YkNsaWVudC5nZXRMYXRlc3RSZWxlYXNlKCk7XG4gICAgY29yZS5kZWJ1ZyhgbGF0ZXN0IHJlbGVhc2U6ICR7SlNPTi5zdHJpbmdpZnkobGF0ZXN0UmVsZWFzZSl9YCk7XG4gICAgY29uc3QgcHVsbFJlcXVlc3RzID0gYXdhaXQgZ2V0UHVsbFJlcXVlc3RzKGdpdENsaWVudCwgZ2l0aHViQ2xpZW50LCBsYXRlc3RSZWxlYXNlKTtcbiAgICBjb3JlLmRlYnVnKCdwdWxsIHJlcXVlc3RzOicgKyBwdWxsUmVxdWVzdHMubWFwKChwcikgPT4gcHIudGl0bGUpLmpvaW4oJ1xcbicpKTtcblxuICAgIGdldExpbmtlZElzc3VlcyhwdWxsUmVxdWVzdHMpOyAvLyBUT0RPXG5cbiAgICAvLyBjb25zdCB0b3RhbENvbW1lbnRzID0gYXdhaXQgY29tbWVudE9uKHB1bGxSZXF1ZXN0cywgaXNzdWVzLCByZWxlYXNlKTtcblxuICAgIGNvcmUuaW5mbygnU3VjY2VzcyEnKTtcbiAgICBjb3JlLnNldE91dHB1dCgndG90YWwtY29tbWVudHMnLCAwKTsgLy8gVE9ET1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvcmUuc2V0RmFpbGVkKGVycm9yLm1lc3NhZ2UpO1xuICB9XG59XG5cbi8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tZmxvYXRpbmctcHJvbWlzZXNcbnJ1bigpOyJdfQ==